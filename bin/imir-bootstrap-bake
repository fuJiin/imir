#!/bin/bash
set -euo pipefail

DEV_USER="dev"

echo "=== Imir Bake: System Setup ==="

# Wait for cloud-init to finish (may hold apt lock)
echo "Waiting for cloud-init..."
cloud-init status --wait 2>/dev/null || true

# ── System packages ────────────────────────────────────────────────

echo "Adding GitHub CLI apt repository..."
mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
    > /etc/apt/sources.list.d/github-cli.list

echo "Installing system packages..."
export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get install -y \
    git \
    gh \
    emacs-nox \
    fish \
    tmux \
    curl \
    jq \
    ripgrep \
    fd-find \
    build-essential \
    unzip

# fd-find installs as fdfind on Ubuntu; symlink to fd
if command -v fdfind &>/dev/null && ! command -v fd &>/dev/null; then
    ln -sf "$(command -v fdfind)" /usr/local/bin/fd
fi

# Install lazygit (not in Ubuntu repos)
echo "Installing lazygit..."
LAZYGIT_VERSION=$(curl -fsSL "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
curl -fsSL "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" \
    | tar xz -C /usr/local/bin lazygit

# ── Dev user ───────────────────────────────────────────────────────

if ! id "$DEV_USER" &>/dev/null; then
    echo "Creating user: $DEV_USER"
    useradd -m -s "$(command -v fish)" -G sudo "$DEV_USER"
    echo "$DEV_USER ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/$DEV_USER"
    chmod 440 "/etc/sudoers.d/$DEV_USER"
fi

# ── User bake hook ─────────────────────────────────────────────────

if [[ -f /tmp/imir-bake-hook ]]; then
    echo "Running bake hook..."
    bash /tmp/imir-bake-hook
fi

echo "=== Bake complete ==="
