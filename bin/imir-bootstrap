#!/bin/bash
set -euo pipefail

CHEZMOI_REPO="${1:?Usage: imir-bootstrap <chezmoi-repo>}"
DEV_USER="dev"

echo "=== Imir Bootstrap ==="

# Wait for cloud-init to finish (may hold apt lock)
echo "Waiting for cloud-init..."
cloud-init status --wait 2>/dev/null || true

# ── System setup (as root) ──────────────────────────────────────────

echo "Adding GitHub CLI apt repository..."
mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
    > /etc/apt/sources.list.d/github-cli.list

echo "Installing system packages..."
apt-get update
apt-get install -y \
    git \
    gh \
    emacs-nox \
    fish \
    tmux \
    curl \
    jq \
    ripgrep \
    fd-find \
    build-essential \
    unzip

# fd-find installs as fdfind on Ubuntu; symlink to fd
if command -v fdfind &>/dev/null && ! command -v fd &>/dev/null; then
    ln -sf "$(command -v fdfind)" /usr/local/bin/fd
fi

# Install lazygit (not in Ubuntu repos)
echo "Installing lazygit..."
LAZYGIT_VERSION=$(curl -fsSL "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
curl -fsSL "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" \
    | tar xz -C /usr/local/bin lazygit

# Create dev user
if ! id "$DEV_USER" &>/dev/null; then
    echo "Creating user: $DEV_USER"
    useradd -m -s "$(command -v fish)" -G sudo "$DEV_USER"
    echo "$DEV_USER ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/$DEV_USER"
    chmod 440 "/etc/sudoers.d/$DEV_USER"
fi

# Copy SSH authorized_keys from root
mkdir -p "/home/$DEV_USER/.ssh"
cp /root/.ssh/authorized_keys "/home/$DEV_USER/.ssh/authorized_keys"
chown -R "$DEV_USER:$DEV_USER" "/home/$DEV_USER/.ssh"
chmod 700 "/home/$DEV_USER/.ssh"
chmod 600 "/home/$DEV_USER/.ssh/authorized_keys"

# ── User setup (as dev) ─────────────────────────────────────────────

echo "Setting up dev environment..."

cat > /tmp/imir-user-setup.sh <<EOF
#!/bin/bash
set -uo pipefail
cd "\$HOME"

# Install chezmoi and apply dotfiles (if configured)
if [ -n "$CHEZMOI_REPO" ]; then
    echo "Applying dotfiles via chezmoi ($CHEZMOI_REPO)..."
    sh -c "\$(curl -fsLS get.chezmoi.io)" -- init --apply "$CHEZMOI_REPO" || {
        echo "Warning: chezmoi apply had errors (dotfiles are likely still applied)."
        echo "Run 'chezmoi apply' manually to retry."
    }
else
    echo "Skipping dotfiles (CHEZMOI_REPO not set)."
fi

# Install Claude Code (native installer, no Node.js required)
echo "Installing Claude Code..."
curl -fsSL https://claude.ai/install.sh | sh

echo "Done!"
EOF

chmod +x /tmp/imir-user-setup.sh
sudo -u "$DEV_USER" bash /tmp/imir-user-setup.sh

echo "=== Imir Bootstrap complete ==="
