#!/bin/bash
set -euo pipefail

CHEZMOI_REPO="${1:?Usage: imir-bootstrap <chezmoi-repo> [baked]}"
BAKED="${2:-false}"
DEV_USER="dev"

echo "=== Imir Bootstrap ==="

# If the image wasn't baked, run the bake script first (fallback path)
if [[ "$BAKED" != "true" ]]; then
    echo "No snapshot — running full system setup..."
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    bash "$SCRIPT_DIR/imir-bootstrap-bake"
fi

# ── Per-box setup (as root) ────────────────────────────────────────

# Ensure dev user exists (cloud-init may wipe non-default users on snapshot boot)
if ! id "$DEV_USER" &>/dev/null; then
    echo "Creating user: $DEV_USER"
    useradd -m -s "$(command -v fish || echo /bin/bash)" -G sudo "$DEV_USER"
    echo "$DEV_USER ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/$DEV_USER"
    chmod 440 "/etc/sudoers.d/$DEV_USER"
fi

# Ensure home dir exists with correct ownership (snapshot boot can reset this)
mkdir -p "/home/$DEV_USER"
chown "$DEV_USER:$DEV_USER" "/home/$DEV_USER"

# Copy SSH authorized_keys from root
mkdir -p "/home/$DEV_USER/.ssh"
cp /root/.ssh/authorized_keys "/home/$DEV_USER/.ssh/authorized_keys"
chown -R "$DEV_USER:$DEV_USER" "/home/$DEV_USER/.ssh"
chmod 700 "/home/$DEV_USER/.ssh"
chmod 600 "/home/$DEV_USER/.ssh/authorized_keys"

# ── User setup (as dev) ─────────────────────────────────────────────

echo "Setting up dev environment..."

cat > /tmp/imir-user-setup.sh <<EOF
#!/bin/bash
set -uo pipefail
cd "\$HOME"

# Install chezmoi and apply dotfiles (if configured)
if [ -n "$CHEZMOI_REPO" ]; then
    echo "Applying dotfiles via chezmoi ($CHEZMOI_REPO)..."
    mkdir -p "\$HOME/bin"
    sh -c "\$(curl -fsLS get.chezmoi.io)" -- init --apply "$CHEZMOI_REPO" || {
        echo "Warning: chezmoi apply had errors (dotfiles are likely still applied)."
        echo "Run 'chezmoi apply' manually to retry."
    }
else
    echo "Skipping dotfiles (CHEZMOI_REPO not set)."
fi

# Install Claude Code (native installer, no Node.js required)
echo "Installing Claude Code..."
curl -fsSL https://claude.ai/install.sh | bash

echo "Done!"
EOF

chmod +x /tmp/imir-user-setup.sh
sudo -u "$DEV_USER" bash /tmp/imir-user-setup.sh

echo "=== Imir Bootstrap complete ==="
