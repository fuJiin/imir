#!/bin/bash
set -euo pipefail

IMIR_BIN_DIR="$(cd "$(dirname "$0")" && pwd)"
IMIR_CONFIG_DIR="${IMIR_CONFIG_DIR:-${XDG_CONFIG_HOME:-$HOME/.config}/imir}"
IMIR_CONFIG="$IMIR_CONFIG_DIR/config.env"

# ── Helpers ───────────────────────────────────────────────────────────

imir::load_config() {
    if [[ ! -f "$IMIR_CONFIG" ]]; then
        echo "Config not found: $IMIR_CONFIG" >&2
        echo "Run 'imir init' to create it." >&2
        exit 1
    fi
    source "$IMIR_CONFIG"
    export HCLOUD_TOKEN
}

imir::ssh_key() {
    echo "${SSH_KEY_PATH/#\~/$HOME}"
}

imir::server_ip() {
    local name="$1"
    local ip
    ip=$(hcloud server ip "imir-$name" 2>/dev/null) || {
        echo "Error: dev box '$name' not found." >&2
        echo "Run 'imir list' to see available boxes." >&2
        exit 1
    }
    echo "$ip"
}

imir::usage() {
    cat <<'EOF'
Usage: imir <command> [args]

Commands:
  init                       Create config file at ~/.config/imir/config.env
  uninstall                  Remove imir and all its files
  create   <name> [type]     Create and bootstrap a new dev box
  connect  <name> [session]  SSH into a box and attach to a tmux session
  ssh      <name> [cmd...]   Plain SSH (no tmux). Runs cmd if given
  ip       <name>            Print a box's IP address
  sessions <name>            List tmux sessions on a box
  list                       Show all running imir-managed dev boxes
  rename   <old> <new>       Rename a dev box
  destroy  <name>            Destroy a dev box and clean up known_hosts
  help                       Show this help message

EOF
}

# ── Commands ──────────────────────────────────────────────────────────

cmd::init() {
    if [[ -f "$IMIR_CONFIG" ]]; then
        echo "Config already exists: $IMIR_CONFIG"
        echo "Edit it directly, or remove it to start fresh."
        return
    fi
    mkdir -p "$IMIR_CONFIG_DIR"
    cat > "$IMIR_CONFIG" <<'TMPL'
# Hetzner Cloud API token
# Create at: https://console.hetzner.cloud → project → Security → API tokens
HCLOUD_TOKEN=

# SSH key (local path to private key; .pub will be auto-detected)
SSH_KEY_PATH=~/.ssh/id_rsa

# Chezmoi dotfiles repo (GitHub shorthand)
CHEZMOI_REPO=fuJiin/dotfiles

# Server defaults
DEFAULT_SERVER_TYPE=cpx21
DEFAULT_LOCATION=hil
DEFAULT_IMAGE=ubuntu-24.04
TMPL
    chmod 600 "$IMIR_CONFIG"
    echo "Created $IMIR_CONFIG"
    echo "Edit it and set at least HCLOUD_TOKEN."
}

cmd::uninstall() {
    echo "This will remove imir from your system:"
    echo "  - $IMIR_BIN_DIR/imir"
    echo "  - $IMIR_BIN_DIR/imir-bootstrap"

    local fish_comp="${XDG_CONFIG_HOME:-$HOME/.config}/fish/completions/imir.fish"
    if [[ -f "$fish_comp" ]]; then
        echo "  - $fish_comp"
    fi

    if [[ -d "$IMIR_CONFIG_DIR" ]]; then
        echo "  - $IMIR_CONFIG_DIR/ (contains your config and API token)"
    fi

    # Check for running boxes
    if [[ -f "$IMIR_CONFIG" ]]; then
        source "$IMIR_CONFIG"
        export HCLOUD_TOKEN
        local boxes
        boxes=$(hcloud server list -l managed-by=imir -o noheader -o columns=name 2>/dev/null | sed 's/^imir-//' || true)
        if [[ -n "$boxes" ]]; then
            echo ""
            echo "Warning: you have running dev boxes (billed hourly):"
            echo "$boxes" | sed 's/^/  - /'
            echo "These will NOT be destroyed. Run 'imir destroy <name>' first, or"
            echo "delete them manually at https://console.hetzner.cloud"
        fi
    fi

    echo ""
    read -rp "Proceed? [y/N] " confirm
    if [[ "$confirm" != [yY] ]]; then
        echo "Cancelled."
        return
    fi

    rm -f "$fish_comp"
    rm -rf "$IMIR_CONFIG_DIR"
    rm -f "$IMIR_BIN_DIR/imir-bootstrap"
    rm -f "$IMIR_BIN_DIR/imir"

    echo "imir has been uninstalled."
}

cmd::create() {
    local name="${1:?Usage: imir create <name> [server-type]}"
    local server_type="${2:-$DEFAULT_SERVER_TYPE}"
    local ssh_key
    ssh_key=$(imir::ssh_key)

    echo "Creating dev box: $name ($server_type in $DEFAULT_LOCATION)..."

    # Ensure at least one imir-* SSH key exists in Hetzner
    local imir_keys
    imir_keys=$(hcloud ssh-key list -o noheader -o columns=name | grep '^imir-' || true)
    if [ -z "$imir_keys" ]; then
        echo "Uploading SSH key to Hetzner..."
        hcloud ssh-key create --name imir-laptop --public-key-from-file "${ssh_key}.pub"
        imir_keys="imir-laptop"
    fi

    # Check if server already exists
    if hcloud server describe "imir-$name" &>/dev/null; then
        echo "Error: dev box '$name' already exists. Use 'imir destroy' first."
        exit 1
    fi

    # Build --ssh-key flags for all imir-* keys
    local ssh_key_flags=()
    while IFS= read -r key; do
        ssh_key_flags+=(--ssh-key "$key")
    done <<< "$imir_keys"

    # Create server
    hcloud server create \
        --name "imir-$name" \
        --type "$server_type" \
        --location "$DEFAULT_LOCATION" \
        --image "$DEFAULT_IMAGE" \
        "${ssh_key_flags[@]}" \
        --label managed-by=imir

    # Get IP
    local ip
    ip=$(hcloud server ip "imir-$name")
    echo "Server IP: $ip"

    # Wait for SSH to become available
    echo "Waiting for SSH..."
    for i in $(seq 1 30); do
        if ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=5 -i "$ssh_key" root@"$ip" true 2>/dev/null; then
            break
        fi
        if [ "$i" -eq 30 ]; then
            echo "Error: SSH connection timed out."
            exit 1
        fi
        sleep 2
    done

    # Upload and run bootstrap
    echo "Bootstrapping..."
    scp -i "$ssh_key" "$IMIR_BIN_DIR/imir-bootstrap" root@"$ip":/tmp/imir-bootstrap
    ssh -i "$ssh_key" root@"$ip" "bash /tmp/imir-bootstrap '$CHEZMOI_REPO'"

    echo ""
    echo "Dev box '$name' is ready!"
    echo "  Connect:  imir connect $name"
    echo "  IP:       $ip"
    echo "  User:     dev"
}

cmd::connect() {
    local name="${1:?Usage: imir connect <name> [session]}"
    local session="${2:-default}"
    local ssh_key
    ssh_key=$(imir::ssh_key)

    local ip
    ip=$(imir::server_ip "$name") || exit 1

    local ssh_opts=(-A -i "$ssh_key")

    # Devboxes don't have ghostty terminfo; fall back to xterm-256color.
    # SSH sends the client's TERM to the remote, so setting it here is enough.
    export TERM=xterm-256color

    # Attach to (or create) the named tmux session
    exec ssh "${ssh_opts[@]}" -t dev@"$ip" \
        "tmux new-session -As '$session'"
}

cmd::ssh() {
    local name="${1:?Usage: imir ssh <name> [cmd...]}"
    shift
    local ssh_key
    ssh_key=$(imir::ssh_key)

    local ip
    ip=$(imir::server_ip "$name") || exit 1

    export TERM=xterm-256color

    if [ $# -gt 0 ]; then
        exec ssh -A -i "$ssh_key" dev@"$ip" "$@"
    else
        exec ssh -A -i "$ssh_key" dev@"$ip"
    fi
}

cmd::ip() {
    local name="${1:?Usage: imir ip <name>}"
    imir::server_ip "$name" || exit 1
}

cmd::rename() {
    local old="${1:?Usage: imir rename <old-name> <new-name>}"
    local new="${2:?Usage: imir rename <old-name> <new-name>}"

    # Verify source exists
    imir::server_ip "$old" >/dev/null || exit 1

    hcloud server update "imir-$old" --name "imir-$new"
    echo "Renamed '$old' to '$new'."
}

cmd::destroy() {
    local name="${1:?Usage: imir destroy <name>}"

    local ip
    ip=$(imir::server_ip "$name") || exit 1

    echo "Destroying dev box '$name' ($ip)..."
    hcloud server delete "imir-$name"

    # Clean up known_hosts
    ssh-keygen -R "$ip" 2>/dev/null || true

    echo "Dev box '$name' destroyed."
}

cmd::list() {
    hcloud server list -l managed-by=imir -o columns=name,ipv4,status,location \
        | sed 's/^imir-//'
}

cmd::sessions() {
    local name="${1:?Usage: imir sessions <name>}"
    local ssh_key
    ssh_key=$(imir::ssh_key)

    local ip
    ip=$(imir::server_ip "$name") || exit 1

    ssh -A -i "$ssh_key" dev@"$ip" "tmux list-sessions"
}

# ── Dispatch ──────────────────────────────────────────────────────────

command="${1:-help}"
shift || true

case "$command" in
    init)      cmd::init "$@" ;;
    uninstall) cmd::uninstall "$@" ;;
    help|-h|--help) imir::usage ;;
    create|connect|ssh|ip|destroy|list|rename|sessions)
        imir::load_config
        "cmd::$command" "$@"
        ;;
    *)
        echo "Error: unknown command '$command'" >&2
        echo >&2
        imir::usage >&2
        exit 1
        ;;
esac
